# locks/CMakeLists.txt
#
# Build configuration for hand-written lock implementations used with Tilt.
#
# This directory contains lock implementations that are NOT auto-generated by
# lib/lockgen/ but are instead manually written (e.g., the NUMA-aware CNA lock
# wrapper in include/numa_cnalock.h).
#
# These locks are compiled into shared libraries (.so) that Tilt (libmutrep)
# loads via LD_PRELOAD to interpose pthread_mutex calls at runtime.
#
# Dependencies:
#   - deps/libvsync/    (provides the underlying cnalock_t, atomic primitives)
#   - deps/tilt/        (provides the Tilt interposition header)
#
# Note: The auto-generated locks (CAS, TTAS, Ticket, MCS, Hemlock, HMCS) are
# built by generatedlocks/CMakeLists.txt instead.

cmake_minimum_required(VERSION 3.10)

project(tiltlock C)

add_subdirectory(${CMAKE_SOURCE_DIR}/../deps/libvsync/ build_libvsync)

include_directories(include ${CMAKE_SOURCE_DIR}/../deps/tilt/include/)

add_library(taslock SHARED taslock.c)
add_library(caslock SHARED caslock.c)
add_library(vcaslock SHARED vcaslock.c)

target_link_libraries(vcaslock vsync)

if(CMAKE_SYSTEM_PROCESSOR MATCHES "aarch64" OR CMAKE_SYSTEM_PROCESSOR MATCHES "armv8")
    target_compile_options(vcaslock PRIVATE -march=armv8-a+lse)
endif()
